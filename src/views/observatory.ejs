<!DOCTYPE html>
<html>
<head>
  <title>Observatorium - Leitstand</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; }
    nav a { margin-right: 15px; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { text-decoration: underline; }
    .topic { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    .topic h3 { margin-top: 0; }
    .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }

    /* Insights & Negations */
    .section-title { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
    .insight-card { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #fafafa; }
    .insight-card.negation { border-left: 5px solid #d9534f; background: #fff0f0; }
    .insight-card h4 { margin: 0 0 5px 0; font-size: 1.1em; }
    .insight-meta { font-size: 0.85em; color: #555; margin-bottom: 5px; }
    .verdict { font-weight: bold; color: #d9534f; margin-top: 5px; }
    .relation { display: flex; gap: 10px; margin-top: 10px; font-size: 0.9em; }
    .relation-item { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/observatory">Observatorium</a>
  </nav>
  <h1>Observatorium</h1>
  <div class="meta">
    <div><strong>Generated:</strong> <%= data.generated_at || "n/a" %></div>
    <div><strong>Source:</strong>
      <% if (typeof data.source === 'string') { %>
        <%= data.source %>
      <% } else if (data.source && typeof data.source === 'object') { %>
        <%= data.source.source_type %>: <%= data.source.ref %>
      <% } else { %>
        n/a
      <% } %>
    </div>
    <div><strong>ID:</strong> <%= data.observatory_id || "n/a" %></div>
    <div>
      <strong>Quelle:</strong>
      <% if (locals.view_meta && locals.view_meta.source_kind === 'artifact') { %>
        Artefakt (knowledge.observatory.json)
      <% } else if (locals.view_meta && locals.view_meta.source_kind === 'fixture') { %>
        Fixture (Fallback)
      <% } else { %>
        unknown
      <% } %>
    </div>
  </div>

  <div id="runtime-observatory" style="margin-top: 20px; padding: 15px; background: #eef; border: 1px solid #ccd; border-radius: 5px;">
    <h3>Live Data (Runtime Fetch)</h3>
    <div id="obs-runtime-status">Initializing...</div>
    <pre id="obs-runtime-json" style="max-height: 200px; overflow: auto; background: #fff; padding: 10px; border: 1px solid #ddd; display: none;"></pre>
  </div>

  <script>
    (async function() {
      const URL = "<%= locals.observatoryUrl %>";
      const statusEl = document.getElementById("obs-runtime-status");
      const preEl = document.getElementById("obs-runtime-json");

      statusEl.textContent = "Fetching live data from: " + URL;

      try {
        const r = await fetch(URL, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();

        statusEl.innerHTML = "<strong>Live data loaded!</strong><br>" +
                             "Generated: " + (data.generated_at || "n/a") + "<br>" +
                             "Source: " + URL;
        statusEl.style.color = "green";

        preEl.textContent = JSON.stringify(data, null, 2);
        preEl.style.display = "block";
      } catch (e) {
        statusEl.innerHTML = "<strong>Runtime fetch failed.</strong><br>" + String(e) +
                             "<br>Showing build-time data (above).";
        statusEl.style.color = "red";
      }
    })();
  </script>

  <% if (data.insights && data.insights.length > 0) { %>
    <h2 class="section-title">Insights / Conflicts</h2>
    <div class="insights">
      <% data.insights.forEach(function(insight) { %>
        <% if (insight.type === 'insight.negation') { %>
          <div class="insight-card negation">
            <h4>Conflict Detected</h4>
            <div class="insight-meta">ID: <%= insight.id %></div>
            <div class="verdict">Verdict: <%= insight.verdict %></div>
            <div class="relation">
              <% if (insight.relation) { %>
                <span class="relation-item">Thesis: <%= insight.relation.thesis %></span>
                <span class="relation-item">Antithesis: <%= insight.relation.antithesis %></span>
              <% } %>
            </div>
            <!-- Optional: Link to thesis detail if we had a route for it -->
          </div>
        <% } else { %>
          <!-- Generic insight fallback -->
          <div class="insight-card">
            <h4><%= insight.type || 'Generic Insight' %></h4>
            <div class="insight-meta">ID: <%= insight.id %></div>
          </div>
        <% } %>
      <% }); %>
    </div>
  <% } %>

  <h2 class="section-title">Topics</h2>
  <div class="topics">
    <% if (data.topics && data.topics.length > 0) { %>
      <% data.topics.forEach(function(topic) { %>
        <div class="topic">
          <h3><%= topic.title %></h3>
          <% if (topic.summary) { %>
            <p><%= topic.summary %></p>
          <% } %>
          <p><strong>Sources:</strong> <%= topic.sources ? topic.sources.length : 0 %></p>
        </div>
      <% }); %>
    <% } else { %>
      <p>No topics available.</p>
    <% } %>
  </div>
</body>
</html>
