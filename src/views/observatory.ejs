<!DOCTYPE html>
<html>
<head>
  <title>Observatorium - Leitstand</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; }
    nav a { margin-right: 15px; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { text-decoration: underline; }
    .topic { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
    .topic h3 { margin-top: 0; }
    .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
    .empty-state { padding: 40px; background: #f9f9f9; border: 2px dashed #ccc; text-align: center; color: #666; margin-top: 20px; border-radius: 8px; }

    /* Insights & Negations */
    .section-title { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
    .insight-card { margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #fafafa; }
    .insight-card.negation { border-left: 5px solid #d9534f; background: #fff0f0; }
    .insight-card h4 { margin: 0 0 5px 0; font-size: 1.1em; }
    .insight-meta { font-size: 0.85em; color: #555; margin-bottom: 5px; }
    .verdict { font-weight: bold; color: #d9534f; margin-top: 5px; }
    .relation { display: flex; gap: 10px; margin-top: 10px; font-size: 0.9em; }
    .relation-item { background: #eee; padding: 2px 6px; border-radius: 3px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/observatory">Observatorium</a>
  </nav>
  <h1>Observatorium</h1>

  <!-- STRICT MODE & FORENSICS (Always Visible) -->
  <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; background: #fff; font-size: 0.85em; color: #555;">
    <div><strong>Strict Mode:</strong>
        <% if (locals.view_meta && locals.view_meta.is_strict) { %>
            <span style="color: #d9534f; font-weight: bold;">ON</span>
        <% } else { %>
            <span style="color: #666;">OFF</span>
        <% } %>
    </div>
    <% if (locals.view_meta && locals.view_meta.forensics && locals.view_meta.forensics.fetched_at) { %>
      <div style="margin-top: 5px; border-top: 1px dashed #ddd; padding-top: 5px;">
        <strong>Forensics:</strong><br>
        Fetched At: <%= locals.view_meta.forensics.fetched_at %><br>
        <% if (locals.view_meta.forensics.observatory) { %>
           Raw Bytes: <%= locals.view_meta.forensics.observatory.bytes %> | Source: <%= locals.view_meta.forensics.observatory.source_url %><br>
        <% } %>
        <% if (locals.view_meta.forensics.insights_daily) { %>
           Daily Bytes: <%= locals.view_meta.forensics.insights_daily.bytes %> | Source: <%= locals.view_meta.forensics.insights_daily.source_url %>
        <% } %>
      </div>
    <% } %>
  </div>

  <!-- RUNTIME DEBUG (Always Available) -->
  <div id="runtime-observatory" style="margin-top: 10px; padding: 10px; background: #eef; border: 1px solid #ccd; border-radius: 5px; display: none; font-size: 0.9em;">
    <h3 style="margin-top:0;">Debug: Runtime Fetch</h3>
    <p style="margin-top:0; color:#666; font-size:0.9em;">Checks connectivity to upstream Release Asset. Does <strong>not</strong> verify local build artifacts.</p>
    <div id="obs-runtime-status">Initializing...</div>
    <pre id="obs-runtime-json" style="max-height: 200px; overflow: auto; background: #fff; padding: 10px; border: 1px solid #ddd;"></pre>
  </div>
  <script>
    (async function() {
      const URL = "<%= locals.observatoryUrl %>";
      const debugContainer = document.getElementById("runtime-observatory");
      const statusEl = document.getElementById("obs-runtime-status");
      const preEl = document.getElementById("obs-runtime-json");

      const isDebug = new URLSearchParams(window.location.search).get("debug") === "1";
      if (isDebug) debugContainer.style.display = "block";

      statusEl.textContent = "Fetching live data from: " + URL;

      try {
        const r = await fetch(URL, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();

        // Update Metadata
        const genEl = document.getElementById("obs-generated-at");
        if (genEl) genEl.textContent = (data.generated_at || "n/a") + " (Live)";
        const srcEl = document.getElementById("obs-source-desc");
        if (srcEl) srcEl.textContent = "Live from Release Asset";

        // Update Topics (only if container exists - i.e. not empty state)
        const topicsContainer = document.getElementById("obs-topics-container");
        if (topicsContainer) {
          topicsContainer.textContent = ""; // Clear existing content
          if (data.topics && Array.isArray(data.topics) && data.topics.length > 0) {
            data.topics.forEach(t => {
              const topicDiv = document.createElement("div");
              topicDiv.className = "topic";
              const h3 = document.createElement("h3");
              h3.textContent = t.title || "Untitled topic";
              topicDiv.appendChild(h3);
              if (t.summary) {
                const pSummary = document.createElement("p");
                pSummary.textContent = t.summary;
                topicDiv.appendChild(pSummary);
              }
              const pSources = document.createElement("p");
              const strong = document.createElement("strong");
              strong.textContent = "Sources: ";
              pSources.appendChild(strong);
              pSources.appendChild(document.createTextNode(t.sources ? t.sources.length : 0));
              topicDiv.appendChild(pSources);
              topicsContainer.appendChild(topicDiv);
            });
          } else {
            const p = document.createElement("p");
            p.textContent = "No topics available.";
            topicsContainer.appendChild(p);
          }
        }

        // Debug Output
        statusEl.innerHTML = "<strong>Live data loaded!</strong>";
        statusEl.style.color = "green";
        if (isDebug) {
          preEl.textContent = JSON.stringify(data, null, 2);
        }
      } catch (e) {
        statusEl.innerHTML = "<strong>Runtime fetch failed.</strong><br>" + String(e);
        statusEl.style.color = "red";
        if (isDebug) console.error("Observatory Runtime Fetch Error:", e);
      }
    })();
  </script>

  <% if (data) { %>
  <div class="meta">
    <div><strong>Generated:</strong> <span id="obs-generated-at"><%= data.generated_at || "n/a" %></span></div>
    <div><strong>Source:</strong> <span id="obs-source-desc">
      <% if (typeof data.source === 'string') { %>
        <%= data.source %>
      <% } else if (data.source && typeof data.source === 'object') { %>
        <%= data.source.source_type %>: <%= data.source.ref %>
      <% } else { %>
        n/a
      <% } %>
    </span></div>
    <div><strong>ID:</strong> <%= data.observatory_id || "n/a" %></div>
    <div>
      <strong>Quelle:</strong>
      <% if (locals.view_meta && locals.view_meta.source_kind === 'artifact') { %>
        Artefakt (knowledge.observatory.json)
      <% } else if (locals.view_meta && locals.view_meta.source_kind === 'fixture') { %>
        <span style="color: #d9534f; font-weight: bold;">Fixture (Fallback) - Live Data Missing</span>
      <% } else { %>
        unknown
      <% } %>
    </div>
  </div>

  <% if (locals.view_meta && locals.view_meta.source_kind === 'fixture') { %>
    <div style="background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
      <strong>⚠️ Warning:</strong> This view is running in fallback mode using static fixture data. The live knowledge artifact could not be loaded.
    </div>
  <% } %>

  <!-- INTEGRITY SECTION (New Panel) -->
  <h2 class="section-title">System Integrity</h2>
  <div style="background: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 5px; margin-bottom: 30px;">
    <% if (locals.integritySummaries && locals.integritySummaries.length > 0) { %>
      <%
             // Build list of repos to display
             // 1. Start with known repos from fleet metrics (if available)
             // 2. Add any repos found in integrity summaries (even if not in fleet metrics)

             const reposMap = new Map();

             // Add from metrics
             if (locals.fleetMetrics && locals.fleetMetrics.repos) {
                locals.fleetMetrics.repos.forEach(r => {
                   if (typeof r === 'string') {
                      reposMap.set(r, { name: r, status: 'MISSING', isMissing: true });
                   } else if (r.name) {
                      reposMap.set(r.name, { name: r.name, status: 'MISSING', isMissing: true });
                   }
                });
             }

             // Add/Merge from summaries
             locals.integritySummaries.forEach(s => {
                if (s.repo) {
                   reposMap.set(s.repo, { ...s, isMissing: false });
                }
             });

             // Convert to array and sort alphabetically
             const repoList = Array.from(reposMap.values()).sort((a, b) => {
                 const nameA = a.name || a.repo || 'unknown';
                 const nameB = b.name || b.repo || 'unknown';
                 return nameA.localeCompare(nameB);
             });

         // Calculate Aggregate Status using Explicit Status Fields (Contract-First)
         // Ranking: FAIL > GAP > WARN > UNCLEAR > MISSING > OK
         // We treat MISSING as a high-severity state (similar to UNCLEAR or WARN) because we lost observability.

         let aggGap = 0;
         let aggClaims = 0;
         let aggArtifacts = 0;
         let statusRank = 0; // 0=OK, 1=UNCLEAR, 2=WARN, 3=GAP, 4=FAIL

         repoList.forEach(s => {
             aggGap += (s.counts?.loop_gaps || 0);
             aggClaims += (s.counts?.claims || 0);
             aggArtifacts += (s.counts?.artifacts || 0);

             let st = (s.status || 'OK').toUpperCase();
             if (s.isMissing) st = 'MISSING';

             let rank = 0;
             if (st === 'UNCLEAR') rank = 1;
             else if (st === 'WARN') rank = 2;
             else if (st === 'GAP') rank = 3;
             else if (st === 'MISSING') rank = 4; // Rank MISSING as FAIL-level
             else if (st === 'FAIL') rank = 4;

             if (rank > statusRank) statusRank = rank;
         });

         // Determine text/color based on rank
         let aggStatus = 'OK';
         let aggColor = '#1b5e20';
         let aggBg = '#c8e6c9';

         if (statusRank === 4) {
            aggStatus = 'FAIL';
            aggColor = '#b71c1c';
            aggBg = '#ffcdd2';
         } else if (statusRank === 3) {
            aggStatus = 'GAP';
            aggColor = '#bf360c';
            aggBg = '#ffccbc';
         } else if (statusRank === 2) {
            // Check if it's purely MISSING or mixed
            const hasMissing = repoList.some(r => r.isMissing);
            const hasWarn = repoList.some(r => (r.status||'').toUpperCase() === 'WARN');

            if (hasWarn) {
                aggStatus = 'WARN';
                aggColor = '#e65100';
                aggBg = '#ffe0b2';
            } else if (hasMissing) {
                aggStatus = 'MISSING (Partial)'; // Or just WARN
                aggColor = '#e65100'; // Orange
                aggBg = '#ffe0b2';
            } else {
                aggStatus = 'WARN'; // Default fallback
                aggColor = '#e65100';
                aggBg = '#ffe0b2';
            }
         } else if (statusRank === 1) {
            aggStatus = 'UNCLEAR';
            aggColor = '#f57f17';
            aggBg = '#fff9c4';
         }
      %>

      <div style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
         <div>
             <strong>Source:</strong>
             <% if (locals.view_meta && locals.view_meta.integrity_source_kind === 'artifact') { %>
                integrity/*.json (Artifact)
             <% } else { %>
                integrity/*.json (Fixture)
             <% } %>
         </div>
         <div style="font-weight: bold; padding: 5px 10px; border-radius: 4px; background-color: <%= aggBg %>; color: <%= aggColor %>;">
            Overall Status: <%= aggStatus %>
         </div>
      </div>

      <!-- Repo Table -->
      <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; border-radius: 4px; overflow: hidden; font-size: 0.9em;">
        <thead>
          <tr style="background: #f5f5f5; text-align: left; border-bottom: 2px solid #ddd;">
            <th style="padding: 10px;">Repo</th>
            <th style="padding: 10px;">Status</th>
            <th style="padding: 10px;">Counts / Details</th>
            <th style="padding: 10px;">Generated At</th>
            <th style="padding: 10px;"></th>
          </tr>
        </thead>
        <tbody>
          <%
             repoList.forEach(function(s) {
                 // Ensure name is set for display
                 s.name = s.name || s.repo || 'unknown';

                 // Strict status source: default to UNKNOWN if missing, never assume OK
                 let status = s.status || 'UNKNOWN';
                 let color = 'gray';

                 if (s.isMissing) {
                     status = 'MISSING';
                     color = '#999';
                 } else {
                     // Map status to colors
                     if (status === 'OK') color = 'green';
                     else if (status === 'WARN' || status === 'UNCLEAR') color = 'orange';
                     else if (status === 'FAIL' || status === 'GAP') color = 'red';
                 }
          %>
          <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 10px; font-weight: bold;"><%= s.name || 'unknown' %></td>
            <td style="padding: 10px; color: <%= color %>; font-weight: bold;"><%= status %></td>
            <td style="padding: 10px; font-size: 0.85em; color: #555;">
               <% if (s.counts && typeof s.counts === 'object') { %>
                  <% Object.keys(s.counts).sort().forEach(function(key, index, arr) { %>
                     <span style="white-space: nowrap;">
                       <%= key %>: <strong><%= s.counts[key] %></strong><%= index < arr.length - 1 ? ', ' : '' %>
                     </span>
                  <% }); %>
               <% } else { %>
                  <% if (status === 'OK') { %>
                      <span style="color: #999; font-style: italic;">(minimal)</span>
                  <% } else { %>
                      <span style="color: #d9534f; font-style: italic;">(unavailable)</span>
                  <% } %>
               <% } %>
            </td>
            <td style="padding: 10px; color: #666;"><%= s.generated_at || '' %></td>
            <td style="padding: 10px; text-align: right;">
               <% if (s.summary_url) { %>
                  <a href="<%= s.summary_url %>" target="_blank" style="text-decoration: none; color: #1976d2;">&rarr;</a>
               <% } %>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>

      <!-- Aggregated Metrics -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;">
         <div style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #ddd;">
            <div style="font-size: 1.5em; font-weight: bold; color: #333;"><%= aggClaims %></div>
            <div style="color: #666; font-size: 0.8em;">Total Claims</div>
         </div>
         <div style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #ddd;">
            <div style="font-size: 1.5em; font-weight: bold; color: #333;"><%= aggArtifacts %></div>
            <div style="color: #666; font-size: 0.8em;">Total Artifacts</div>
         </div>
         <div style="background: #fff; padding: 10px; border-radius: 4px; text-align: center; border: 1px solid #ddd;">
            <div style="font-size: 1.5em; font-weight: bold; color: #d9534f;"><%= aggGap %></div>
            <div style="color: #666; font-size: 0.8em;">Total Gaps</div>
         </div>
      </div>

    <% } else { %>
       <div style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
         <div>
             <strong>Source:</strong> MISSING
         </div>
         <div style="font-weight: bold; padding: 5px 10px; border-radius: 4px; background-color: #eceff1; color: #455a64;">
            Status: MISSING
         </div>
       </div>
       <p style="color: #666; font-style: italic;">
         <% if (locals.view_meta && locals.view_meta.is_strict) { %>
            Integrity summary not found (Strict Mode).
         <% } else { %>
            Integrity summary not found.
         <% } %>
       </p>
    <% } %>
  </div>

  <!-- PUBLISHED KNOWLEDGE SECTION -->
  <h2 class="section-title">Verdichtete Erkenntnis (Published Daily)</h2>
  <div style="background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 5px; margin-bottom: 30px;">
    <% if (locals.insightsDaily) { %>
       <div style="margin-bottom: 10px;">
         <strong>Source:</strong>
         <% if (locals.view_meta && locals.view_meta.insights_source_kind === 'artifact') { %>
            insights.daily.json (Artifact)
         <% } else { %>
            insights.daily.json (Fixture)
         <% } %>
       </div>
       <div style="margin-bottom: 10px;">
         <strong>Date:</strong> <%= locals.insightsDaily.ts || 'n/a' %>
       </div>

       <% if (locals.insightsDaily.source) { %>
         <div style="margin-bottom: 10px;">
           <strong>Source ID:</strong> <%= locals.insightsDaily.source %>
         </div>
       <% } %>

       <% if (locals.insightsDaily.metadata) { %>
         <% if (locals.insightsDaily.metadata.generated_at) { %>
            <div style="margin-bottom: 10px;">
              <strong>Generated:</strong> <%= locals.insightsDaily.metadata.generated_at %>
            </div>
         <% } %>
         <% if (locals.insightsDaily.metadata.observatory_ref) { %>
            <div style="margin-bottom: 10px;">
              <strong>Observatory Ref:</strong> <%= locals.insightsDaily.metadata.observatory_ref %>
            </div>
         <% } %>
         <% if (typeof locals.insightsDaily.metadata.uncertainty !== 'undefined') { %>
            <div style="margin-bottom: 10px;">
              <strong>Uncertainty:</strong> <%= locals.insightsDaily.metadata.uncertainty %>
            </div>
         <% } %>
       <% } %>

       <% if (locals.insightsDaily.topics && locals.insightsDaily.topics.length > 0) { %>
         <h4>Topics (Weighted)</h4>
         <ul style="margin-top: 5px; margin-bottom: 15px;">
           <% locals.insightsDaily.topics.forEach(function(t) { %>
             <li><%= t[0] %> <span style="color:#666; font-size:0.9em;">(<%= t[1] %>)</span></li>
           <% }); %>
         </ul>
       <% } %>

       <% if (locals.insightsDaily.questions && locals.insightsDaily.questions.length > 0) { %>
         <h4>Open Questions</h4>
         <ul style="margin-top: 5px; margin-bottom: 15px;">
           <% locals.insightsDaily.questions.forEach(function(q) { %>
             <li><%= q %></li>
           <% }); %>
         </ul>
       <% } %>

       <% if (locals.insightsDaily.deltas && locals.insightsDaily.deltas.length > 0) { %>
         <h4>Deltas (Changes)</h4>
         <ul style="margin-top: 5px; margin-bottom: 15px;">
           <% locals.insightsDaily.deltas.forEach(function(d) { %>
             <li><%= d %></li>
           <% }); %>
         </ul>
       <% } %>

    <% } else { %>
       <% if (locals.view_meta && locals.view_meta.is_strict) { %>
          <p style="color: #d9534f; font-weight: bold;">No published insights available (Strict Mode - Artifact missing).</p>
       <% } else { %>
          <p style="color: #666; font-style: italic;">No daily insights published yet (Dev Fallback).</p>
       <% } %>
    <% } %>
  </div>

  <!-- RAW KNOWLEDGE SECTION -->
  <h2 class="section-title">Erkenntnisraum (Raw Observatory)</h2>

  <% if (data.insights && data.insights.length > 0) { %>
    <h2 class="section-title">Insights / Conflicts</h2>
    <div class="insights">
      <% data.insights.forEach(function(insight) { %>
        <% if (insight.type === 'insight.negation') { %>
          <div class="insight-card negation">
            <h4>Conflict Detected</h4>
            <div class="insight-meta">ID: <%= insight.id %></div>
            <div class="verdict">Verdict: <%= insight.verdict %></div>
            <div class="relation">
              <% if (insight.relation) { %>
                <span class="relation-item">Thesis: <%= insight.relation.thesis %></span>
                <span class="relation-item">Antithesis: <%= insight.relation.antithesis %></span>
              <% } %>
            </div>
            <!-- Optional: Link to thesis detail if we had a route for it -->
          </div>
        <% } else { %>
          <!-- Generic insight fallback -->
          <div class="insight-card">
            <h4><%= insight.type || 'Generic Insight' %></h4>
            <div class="insight-meta">ID: <%= insight.id %></div>
          </div>
        <% } %>
      <% }); %>
    </div>
  <% } %>

  <h2 class="section-title">Topics</h2>
  <div class="topics" id="obs-topics-container">
    <% if (data.topics && data.topics.length > 0) { %>
      <% data.topics.forEach(function(topic) { %>
        <div class="topic">
          <h3><%= topic.title %></h3>
          <% if (topic.summary) { %>
            <p><%= topic.summary %></p>
          <% } %>
          <p><strong>Sources:</strong> <%= topic.sources ? topic.sources.length : 0 %></p>
        </div>
      <% }); %>
    <% } else { %>
      <p>No topics available.</p>
    <% } %>
  </div>

  <% } else { %>
    <!-- EMPTY STATE -->
    <div class="empty-state">
        <h3>Leitstand: No Observation Data</h3>
        <p>
            <% if (locals.view_meta && locals.view_meta.is_strict) { %>
                Strict Mode is ON. Artifacts are missing, and fixture fallback is disabled.
            <% } else { %>
                No data available.
            <% } %>
        </p>
        <% if (locals.view_meta && locals.view_meta.missing_reason) { %>
          <p style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
            raw_reason: <strong><%= locals.view_meta.missing_reason %></strong>
          </p>
        <% } %>
        <% if (locals.view_meta && locals.view_meta.insights_missing_reason) { %>
          <p style="margin-top:5px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">
            daily_reason: <strong><%= locals.view_meta.insights_missing_reason %></strong>
          </p>
        <% } %>
    </div>
  <% } %>
</body>
</html>
