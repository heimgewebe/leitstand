<!DOCTYPE html>
<html>
<head>
  <title>Ops Control - Leitstand</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; }
    nav a { margin-right: 15px; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .panel { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    button { padding: 8px 16px; cursor: pointer; }
    button.primary { background: #007bff; color: white; border: none; border-radius: 4px; }
    button.danger { background: #dc3545; color: white; border: none; border-radius: 4px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    pre { background: #333; color: #eee; padding: 15px; border-radius: 4px; overflow: auto; max-height: 400px; }

    .status-ok { color: green; font-weight: bold; }
    .status-warn { color: orange; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }

    .routine-card { background: white; border: 1px solid #ccc; padding: 15px; margin-top: 10px; border-radius: 4px; }
    .routine-header { display: flex; justify-content: space-between; font-weight: bold; }
    .routine-actions { margin-top: 10px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/observatory">Observatorium</a>
    <a href="/ops">Ops</a>
  </nav>

  <h1>Agent Control Surface (ACS)</h1>

  <div class="panel">
    <div class="header">
      <h2>Git Health Audit</h2>
      <label>
        Repo:
        <select id="repoSelect">
          <option value="metarepo">metarepo</option>
          <option value="wgx">wgx</option>
          <option value="leitstand">leitstand</option>
        </select>
      </label>
      <button id="runAuditBtn" class="primary">Run Audit</button>
    </div>

    <div id="auditResult" style="display: none;">
      <div id="statusSummary" style="margin-bottom: 10px; font-size: 1.2em;"></div>

      <details open>
        <summary>Audit Artifact (JSON)</summary>
        <pre id="auditJson"></pre>
      </details>

      <div id="routinesSection" style="margin-top: 20px; display: none;">
        <h3>Suggested Repair Routines</h3>
        <div id="routinesList"></div>
      </div>
    </div>
  </div>

  <script>
    const repoSelect = document.getElementById('repoSelect');
    const runAuditBtn = document.getElementById('runAuditBtn');
    const auditResult = document.getElementById('auditResult');
    const auditJson = document.getElementById('auditJson');
    const statusSummary = document.getElementById('statusSummary');
    const routinesSection = document.getElementById('routinesSection');
    const routinesList = document.getElementById('routinesList');

    let currentAudit = null;

    runAuditBtn.addEventListener('click', async () => {
      const repo = repoSelect.value;
      runAuditBtn.disabled = true;
      runAuditBtn.textContent = 'Auditing...';
      auditResult.style.display = 'none';
      routinesSection.style.display = 'none';

      try {
        const res = await fetch(`/api/ops/audit/git?repo=${repo}`);
        const data = await res.json();
        currentAudit = data;
        renderAudit(data);
      } catch (e) {
        alert('Audit failed: ' + e);
      } finally {
        runAuditBtn.disabled = false;
        runAuditBtn.textContent = 'Run Audit';
      }
    });

    function renderAudit(data) {
      auditResult.style.display = 'block';
      auditJson.textContent = JSON.stringify(data, null, 2);

      statusSummary.className = `status-${data.status}`;
      statusSummary.textContent = `Status: ${data.status.toUpperCase()}`;

      routinesList.innerHTML = '';
      if (data.suggested_routines && data.suggested_routines.length > 0) {
        routinesSection.style.display = 'block';
        data.suggested_routines.forEach(routine => {
          const card = document.createElement('div');
          card.className = 'routine-card';
          card.innerHTML = `
            <div class="routine-header">
              <span>${routine.id}</span>
              <span style="color: ${routine.risk === 'low' ? 'green' : 'red'}">Risk: ${routine.risk}</span>
            </div>
            <p>${routine.reason}</p>
            <div class="routine-actions">
              <button onclick="previewRoutine('${routine.id}')">Preview Dry-Run</button>
            </div>
            <div id="preview-${routine.id}" style="margin-top: 10px; display: none;">
              <pre style="background: #eee; color: #333; max-height: 200px;"></pre>
              <button class="danger" onclick="applyRoutine('${routine.id}')">Confirm & Apply</button>
            </div>
          `;
          routinesList.appendChild(card);
        });
      }
    }

    window.previewRoutine = async (id) => {
      const repo = repoSelect.value;
      const previewDiv = document.getElementById(`preview-${id}`);
      const pre = previewDiv.querySelector('pre');
      const applyBtn = previewDiv.querySelector('button');

      try {
        pre.textContent = 'Generating preview...';
        previewDiv.style.display = 'block';

        const res = await fetch('/api/ops/routine/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo, routine_id: id })
        });
        const data = await res.json();
        pre.textContent = JSON.stringify(data.steps, null, 2);

        // Store token on button
        applyBtn.dataset.token = data.confirm_token;
      } catch (e) {
        pre.textContent = 'Preview failed: ' + e;
      }
    };

    window.applyRoutine = async (id) => {
      const repo = repoSelect.value;
      const previewDiv = document.getElementById(`preview-${id}`);
      const applyBtn = previewDiv.querySelector('button');
      const token = applyBtn.dataset.token;

      if (!confirm('Are you sure you want to mutate the system state?')) return;

      try {
        applyBtn.disabled = true;
        applyBtn.textContent = 'Applying...';

        const res = await fetch('/api/ops/routine/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ repo, routine_id: id, confirm_token: token })
        });
        const data = await res.json();

        alert(`Success! Routine ${id} applied.\n\nChanges:\n${data.stdout}`);
        // Re-run audit
        runAuditBtn.click();
      } catch (e) {
        alert('Apply failed: ' + e);
        applyBtn.disabled = false;
        applyBtn.textContent = 'Confirm & Apply';
      }
    };
  </script>
</body>
</html>
