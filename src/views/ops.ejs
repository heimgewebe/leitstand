<!DOCTYPE html>
<html>
<head>
  <title>Ops Control - Leitstand</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; }
    nav a { margin-right: 15px; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .panel { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    button { padding: 8px 16px; cursor: pointer; }
    button.primary { background: #007bff; color: white; border: none; border-radius: 4px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    pre { background: #333; color: #eee; padding: 15px; border-radius: 4px; overflow: auto; max-height: 400px; }

    .status-ok { color: green; font-weight: bold; }
    .status-warn { color: orange; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }

    .routine-card { background: white; border: 1px solid #ccc; padding: 15px; margin-top: 10px; border-radius: 4px; }
    .routine-header { display: flex; justify-content: space-between; font-weight: bold; }
    .routine-actions { margin-top: 10px; background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb; }

    .acs-link { color: #0056b3; font-weight: bold; text-decoration: none; display: inline-block; }
    .acs-link:hover { text-decoration: underline; }
    .acs-info { font-size: 0.85em; color: #555; margin-top: 5px; }

    .poll-indicator { margin-left: 10px; color: #666; font-style: italic; display: none; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/observatory">Observatorium</a>
    <a href="/ops">Ops</a>
  </nav>

  <h1>Ops Viewer (may trigger audit jobs)</h1>

  <div class="panel">
    <div class="header">
      <h2>Git Health Audit</h2>
      <label>
        Repo:
        <select id="repoSelect">
          <option value="metarepo">metarepo</option>
          <option value="wgx">wgx</option>
          <option value="leitstand">leitstand</option>
        </select>
      </label>
      <div style="display: flex; align-items: center;">
        <span id="pollIndicator" class="poll-indicator">Waiting for job...</span>
        <button id="runAuditBtn" class="primary">Refresh View (via ACS)</button>
      </div>
    </div>

    <div class="acs-info">
        Data fetched from Agent Control Surface at: <strong><%= locals.acsUrl %></strong>
    </div>

    <div id="auditResult" style="display: none;">
      <div id="statusSummary" style="margin-bottom: 10px; font-size: 1.2em;"></div>

      <details open>
        <summary>Audit Artifact (JSON)</summary>
        <pre id="auditJson"></pre>
      </details>

      <div id="routinesSection" style="margin-top: 20px; display: none;">
        <h3>Suggested Repair Routines</h3>
        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
           ⚠️ Leitstand is a viewer. To apply routines, use the Agent Control Surface (ACS).
        </p>
        <div id="routinesList"></div>
      </div>
    </div>
  </div>

  <script>
    const repoSelect = document.getElementById('repoSelect');
    const runAuditBtn = document.getElementById('runAuditBtn');
    const pollIndicator = document.getElementById('pollIndicator');
    const auditResult = document.getElementById('auditResult');
    const auditJson = document.getElementById('auditJson');
    const statusSummary = document.getElementById('statusSummary');
    const routinesSection = document.getElementById('routinesSection');
    const routinesList = document.getElementById('routinesList');

    // Injected by server
    const ACS_URL = "<%= locals.acsUrl %>";
    const POLL_INTERVAL = 1000;
    const MAX_POLLS = 30; // 30 seconds timeout

    let currentAudit = null;

    runAuditBtn.addEventListener('click', async () => {
      const repo = repoSelect.value;
      startLoading();

      try {
        // Step 1: Try GET /sync (Pragmatic Viewer Approach)
        // This is preferred for a read-only viewer to avoid creating jobs if possible.
        let res = await fetch(`${ACS_URL}/api/audit/git/sync?repo=${repo}`, {
            method: 'GET'
        });

        if (res.status === 404 || res.status === 405) {
            // Sync endpoint not available, fallback to Job Flow (POST)
            console.log("Sync endpoint failed, falling back to Job Flow (POST)");
            res = await fetch(`${ACS_URL}/api/audit/git?repo=${repo}`, {
                method: 'POST'
            });
        }

        if (!res.ok) {
           throw new Error(`HTTP ${res.status}`);
        }

        const initialData = await res.json();

        // Check if we got a Job ID (202 Accepted) or direct result
        if (res.status === 202 && initialData.job_id) {
            pollIndicator.style.display = 'inline';
            pollIndicator.textContent = `Job queued (${initialData.job_id})...`;
            await pollJob(initialData.job_id);
        } else if (initialData.kind === 'audit.git') {
            // Direct result
            renderAudit(initialData);
        } else {
            // Unexpected response
            throw new Error("Unknown response format from ACS");
        }

      } catch (e) {
        handleError(e);
      } finally {
        stopLoading();
      }
    });

    async function pollJob(jobId) {
        let attempts = 0;

        while (attempts < MAX_POLLS) {
            attempts++;
            await new Promise(r => setTimeout(r, POLL_INTERVAL));

            try {
                const res = await fetch(`${ACS_URL}/api/jobs/${jobId}`);
                if (!res.ok) continue; // Retry on transient network error? or fail?

                const job = await res.json();

                // Match on 'done', 'error', 'completed', 'success' to cover potential ACS variations
                if (job.status === 'done' || job.state === 'done' || job.status === 'completed' || job.status === 'success') {
                    // Extract audit result.
                    // ACS job result structure typically: results: [{ action: 'audit.git', audit: {...} }]
                    // Or sometimes directly in result.

                    let audit = null;
                    if (job.result && job.result.audit && job.result.audit.kind === 'audit.git') {
                        audit = job.result.audit;
                    } else if (Array.isArray(job.results)) {
                        const item = job.results.find(r => r.audit && r.audit.kind === 'audit.git');
                        if (item) audit = item.audit;
                    }

                    if (audit) {
                        renderAudit(audit);
                        return;
                    } else {
                        throw new Error("Job completed but no audit artifact found.");
                    }
                } else if (job.status === 'error' || job.status === 'failed' || job.state === 'failed') {
                    throw new Error(`Job failed: ${job.error || 'Unknown error'}`);
                }

                // Still running...
                let stateLabel = job.status || job.state || 'running';
                if (stateLabel === 'queued') stateLabel = 'queued';
                else if (stateLabel === 'running') stateLabel = 'running';

                pollIndicator.textContent = `Job ${stateLabel}... (${attempts}/${MAX_POLLS})`;

            } catch (pollErr) {
                console.warn("Poll error", pollErr);
                // Continue polling? or fail?
            }
        }
        throw new Error("Polling timed out.");
    }

    function startLoading() {
      runAuditBtn.disabled = true;
      runAuditBtn.textContent = 'Fetching from ACS...';
      auditResult.style.display = 'none';
      routinesSection.style.display = 'none';
      pollIndicator.style.display = 'none';
    }

    function stopLoading() {
      runAuditBtn.disabled = false;
      runAuditBtn.textContent = 'Refresh View (via ACS)';
      pollIndicator.style.display = 'none';
    }

    function handleError(e) {
        console.error(e);
        let msg = e.toString();
        const isMixedContent = window.location.protocol === 'https:' && ACS_URL.startsWith('http:');

        if (msg.includes('Failed to fetch') || msg.includes('NetworkError')) {
            msg += '\n\nLikely Causes:';
            if (isMixedContent) {
                msg += '\n- Mixed Content Block: Leitstand is HTTPS but ACS is HTTP. Use HTTPS for ACS or a Reverse Proxy.';
            } else {
                msg += '\n- ACS is not running at ' + ACS_URL;
                msg += '\n- CORS is blocked (ACS must allow Leitstand origin in ACS_CORS_ALLOW_ORIGINS)';
            }
        }
        alert('Failed to fetch audit from ACS.\n\nError: ' + msg);
    }

    function renderAudit(data) {
        // Validate Kind (Minimal Type Safety)
        if (data.kind !== 'audit.git') {
            console.warn('Received unknown data kind:', data.kind);
            alert('Received invalid data format (expected audit.git). Check console.');
            return;
        }

      currentAudit = data;
      auditResult.style.display = 'block';
      auditJson.textContent = JSON.stringify(data, null, 2);

      statusSummary.className = `status-${data.status}`;
      statusSummary.textContent = `Status: ${data.status.toUpperCase()}`;

      routinesList.innerHTML = '';
      if (data.suggested_routines && data.suggested_routines.length > 0) {
        routinesSection.style.display = 'block';
        data.suggested_routines.forEach(routine => {
          const card = document.createElement('div');
          card.className = 'routine-card';
          card.innerHTML = `
            <div class="routine-header">
              <span>${routine.id}</span>
              <span style="color: ${routine.risk === 'low' ? 'green' : 'red'}">Risk: ${routine.risk}</span>
            </div>
            <p>${routine.reason}</p>
            <div class="routine-actions">
              <span>Action required in ACS:</span>
              <a href="${ACS_URL}/#ops-panel" class="acs-link" target="_blank">Open in ACS &rarr;</a>
            </div>
          `;
          routinesList.appendChild(card);
        });
      }
    }
  </script>
</body>
</html>
