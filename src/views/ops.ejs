<!DOCTYPE html>
<html>
<head>
  <title>Ops Control - Leitstand</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; }
    nav a { margin-right: 15px; text-decoration: none; color: #333; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .panel { border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    button { padding: 8px 16px; cursor: pointer; }
    button.primary { background: #007bff; color: white; border: none; border-radius: 4px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    pre { background: #333; color: #eee; padding: 15px; border-radius: 4px; overflow: auto; max-height: 400px; }

    .status-ok { color: green; font-weight: bold; }
    .status-warn { color: orange; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }

    .routine-card { background: white; border: 1px solid #ccc; padding: 15px; margin-top: 10px; border-radius: 4px; }
    .routine-header { display: flex; justify-content: space-between; font-weight: bold; }
    .routine-actions { margin-top: 10px; background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #bbdefb; }

    .acs-link { color: #0056b3; font-weight: bold; text-decoration: none; display: inline-block; }
    .acs-link:hover { text-decoration: underline; }
    .acs-info { font-size: 0.85em; color: #555; margin-top: 5px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a>
    <a href="/observatory">Observatorium</a>
    <a href="/ops">Ops</a>
  </nav>

  <h1>Ops (Read-Only Viewer)</h1>

  <div class="panel">
    <div class="header">
      <h2>Git Health Audit</h2>
      <label>
        Repo:
        <select id="repoSelect">
          <option value="metarepo">metarepo</option>
          <option value="wgx">wgx</option>
          <option value="leitstand">leitstand</option>
        </select>
      </label>
      <button id="runAuditBtn" class="primary">Refresh View (via ACS)</button>
    </div>

    <div class="acs-info">
        Data fetched from Agent Control Surface at: <strong><%= locals.acsUrl %></strong>
    </div>

    <div id="auditResult" style="display: none;">
      <div id="statusSummary" style="margin-bottom: 10px; font-size: 1.2em;"></div>

      <details open>
        <summary>Audit Artifact (JSON)</summary>
        <pre id="auditJson"></pre>
      </details>

      <div id="routinesSection" style="margin-top: 20px; display: none;">
        <h3>Suggested Repair Routines</h3>
        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
           ⚠️ Leitstand is a viewer. To apply routines, use the Agent Control Surface (ACS).
        </p>
        <div id="routinesList"></div>
      </div>
    </div>
  </div>

  <script>
    const repoSelect = document.getElementById('repoSelect');
    const runAuditBtn = document.getElementById('runAuditBtn');
    const auditResult = document.getElementById('auditResult');
    const auditJson = document.getElementById('auditJson');
    const statusSummary = document.getElementById('statusSummary');
    const routinesSection = document.getElementById('routinesSection');
    const routinesList = document.getElementById('routinesList');

    // Injected by server
    const ACS_URL = "<%= locals.acsUrl %>";

    let currentAudit = null;

    runAuditBtn.addEventListener('click', async () => {
      const repo = repoSelect.value;
      runAuditBtn.disabled = true;
      runAuditBtn.textContent = 'Fetching from ACS...';
      auditResult.style.display = 'none';
      routinesSection.style.display = 'none';

      try {
        // Direct call to ACS (CORS must be allowed on ACS side)
        // If this is a skeleton without ACS running, this will fail.
        const res = await fetch(`${ACS_URL}/api/audit/git?repo=${repo}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        currentAudit = data;
        renderAudit(data);
      } catch (e) {
        alert('Failed to fetch audit from ACS.\nMake sure ACS is running at ' + ACS_URL + '\n\nError: ' + e);
        console.error(e);
      } finally {
        runAuditBtn.disabled = false;
        runAuditBtn.textContent = 'Refresh View (via ACS)';
      }
    });

    function renderAudit(data) {
      auditResult.style.display = 'block';
      auditJson.textContent = JSON.stringify(data, null, 2);

      statusSummary.className = `status-${data.status}`;
      statusSummary.textContent = `Status: ${data.status.toUpperCase()}`;

      routinesList.innerHTML = '';
      if (data.suggested_routines && data.suggested_routines.length > 0) {
        routinesSection.style.display = 'block';
        data.suggested_routines.forEach(routine => {
          const card = document.createElement('div');
          card.className = 'routine-card';
          card.innerHTML = `
            <div class="routine-header">
              <span>${routine.id}</span>
              <span style="color: ${routine.risk === 'low' ? 'green' : 'red'}">Risk: ${routine.risk}</span>
            </div>
            <p>${routine.reason}</p>
            <div class="routine-actions">
              <span>Action required in ACS:</span>
              <a href="${ACS_URL}/ops" class="acs-link" target="_blank">Open in ACS &rarr;</a>
            </div>
          `;
          routinesList.appendChild(card);
        });
      }
    }
  </script>
</body>
</html>
